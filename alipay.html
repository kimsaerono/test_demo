<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
    <title>向商户付款</title>
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta name="format-detection" content="telephone=no"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
    <meta http-equiv="description" content="微信支付">
    <link href="font.css" rel="stylesheet" type="text/css"/>
    <link href="iconfontShop.css" rel="stylesheet" type="text/css"/>
    <link href="cashier.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="jquery-1.8.1.min.js"></script>
</head>

<body>
<section class="content">
        <div class="merchantNameTitle">
            <a class="iconfont1 icon">&#xe604;</a><span>${merchantShortName}</span>
        </div>
        <div class="amount-box">
            <div class="border-box">
                <p class="input-amount cashierInput" id="inputAmount"><span>请输入消费金额</span></p>
                <label for="inputAmount">消费金额</label>
                <span class="unit">元</span>
            </div>

        </div>
        <c:if test="${remark_display != 'UNREMARK' }">
	        <div class="remarks">
                <c:if test="${remark_display == 'REMARK_TRUE' }">
                    <span style="color: red;left:0.35rem;top:0.1rem;" class="remark-must-input" >*</span>
                    <span>备注</span>
                    <input type="text" class="remarks-input" name="remark" id="remark" placeholder="必填，30字以内"   maxlength="30"/>
                    <a class="clear-value iconfont">&#xe61e;</a>
                </c:if>
                <c:if test="${remark_display == 'REMARK_FALSE' }">
                    <span>备注</span>
                    <input type="text" class="remarks-input" name="remark" id="remark" placeholder="选填，30字以内"   maxlength="30"/>
                    <a class="clear-value iconfont">&#xe61e;</a>
                </c:if>
	        </div>
        </c:if>
        <input type="button" class="finish-btn disabled" id="pay" value="去支付"  onclick="callpay();"/>
        <input type="hidden" id="openID" value="${openid}"/>
		<input type="hidden" id="ppMerchantNo" value="${ppMerchantNo}"/>
		<input type="hidden" id="merchantName" value="${merchantName}"/>
		<input type="hidden" id="ledgerNo" value="${ledgerNo}"/>
		<input type="hidden" id="deviceNo" value="${deviceNo}"/>
</section>
<!--数字键盘-->
<section class="keyboard-box">
    <table class="keyboard" cellspacing="0" cellpadding="0">
        <tr><td>1</td><td>2</td><td class="b-none">3</td></tr>
        <tr><td>4</td><td>5</td><td class="b-none">6</td></tr>
        <tr><td>7</td><td>8</td><td class="b-none">9</td></tr>
        <tr><td class="point">·</td><td>0</td><td class="del b-none iconfont">&#xe642;</td></tr>
    </table>
</section>
<script type="text/javascript" src="${ctxPath}/cashier_desk_pay/js/keyboard.js?201709071704"></script>
</body>


<script type="text/javascript">
  //支付
  function callpay() {
	 if($("#pay").hasClass("disabled")){
		 return ;
	 }
	$("#pay").addClass("disabled");
    var amount = $("#inputAmount").text();
    var openID = $("#openID").val();
    var merchantNo = $("#ppMerchantNo").val();
    var merchantName = $("#merchantName").val();
    var ledgerNo = $("#ledgerNo").val();
    var deviceNo = $("#deviceNo").val();
    var remark = $("#remark").val();
    $.post("${ctxPath}/cashier/consume", {
      amount: amount,
      openid: openID,
      merchantNo: merchantNo,
      merchantName: merchantName,
      ledgerNo: ledgerNo,
      deviceNo: deviceNo,
      remark: remark,
    }, function (data) {
      if (null == data) {
        window.location.href = '${ctxPath}/cashier/webCallback/fail';
      } else {
        var obj = jQuery.parseJSON(data);
        if (obj.status == 'success') {
          invokeWechatClient(obj);
        }
        else {
          window.location.href = '${ctxPath}/cashier/webCallback/fail/' + obj.msg;
        }
      }
    });
  }

  /**
   * 唤起微信支付
   *
   * @param data
   */
  function invokeWechatClient(data) {
    var dataInfo = data.info;
    var remark = data.remark;
    var obj = jQuery.parseJSON(dataInfo);
    WeixinJSBridge.invoke('getBrandWCPayRequest', {
      "appId": obj.appId,
      "timeStamp": obj.timeStamp,
      "nonceStr": obj.nonceStr,
      "package": obj.package,
      "signType": obj.signType,
      "paySign": obj.paySign
    }, function (res) {
      WeixinJSBridge.log(res.err_msg);
      if (res.err_msg == "get_brand_wcpay_request:ok") {
        location.href = "<%=request.getContextPath()%>/cashier/webCallback/success?orderNo="+data.orderNo+"&remark="+data.remark
        +"&amount="+data.amount
        +"&discountAmount="+data.discountAmount
        +"&tradeTime="+data.tradeTime
        +"&thirdOrderNo="+data.thirdOrderNo
        +"&remark="+obj.remark;
      } else if (res.err_msg == "get_brand_wcpay_request:cancel") {
    	  $("#pay").removeClass("disabled");
      } else {
        location.href = "<%=request.getContextPath()%>/cashier/webCallback/fail";
      }
    });
  }
</script>

</html>